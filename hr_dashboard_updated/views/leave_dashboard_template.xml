<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="leave_dashboard_template" name="Leave Management Dashboard">
    <t t-call="website.layout">
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <style>
        /* Sidebar */
        .dashboard-sidebar {
          position: fixed;
          top: 70px; /* navbar height */
          left: 0;
          height: 100%;
          width: 240px;
          background: #f8f9fa;
          border-right: 1px solid #dee2e6;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          z-index: 1000;
          padding-top: 15px;
        }
        .dashboard-sidebar .list-group-item {
          border: none;
          border-radius: 0;
          padding: 14px 18px;
          font-weight: 500;
          color: #495057;
          transition: all 0.3s ease;
        }
        .dashboard-sidebar .list-group-item:hover {
          background-color: #e9ecef;
        }
        .dashboard-sidebar .list-group-item.active {
          background: linear-gradient(45deg, #0d6efd, #4dabf7);
          color: #fff;
          font-weight: 600;
        }

        /* Content */
        .dashboard-content {
          margin-left: 260px;
          padding: 30px 20px;
        }

        /* Cards */
        .summary-card {
          border-radius: 20px;
          color: #fff;
          padding: 20px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.08);
          transition: transform 0.2s ease;
        }
        .summary-card:hover {
          transform: translateY(-5px);
        }
        .summary-icon {
          font-size: 28px;
          margin-bottom: 10px;
        }

        /* Leave badges */
        .badge-leave {
          padding: 6px 12px;
          border-radius: 12px;
          font-size: 0.9rem;
        }

        /* Tables */
        .table th {
          text-transform: uppercase;
          font-size: 0.85rem;
          letter-spacing: 0.5px;
        }
      </style>

      <div class="container-fluid">
        <div class="row">

          <!-- Sidebar -->
          <div class="dashboard-sidebar">
            <div class="list-group" id="sidebarMenu">
              <a href="/dashboard" class="list-group-item list-group-item-action">
                <i class="fa fa-tachometer-alt me-2"></i> Dashboard
              </a>
              <a href="/dashboard/attendance" class="list-group-item list-group-item-action">
                <i class="fa fa-calendar-check me-2"></i> Track Attendance
              </a>
              <a href="/dashboard/leave" class="list-group-item list-group-item-action active">
                <i class="fa fa-plane-departure me-2"></i> Leave Management
              </a>
              <a href="/dashboard/loan_financial_aid" class="list-group-item list-group-item-action">
                <i class="fa fa-hand-holding-usd me-2"></i> Loan &amp; Financial Aid
              </a>
              <a href="/dashboard/expenses" class="list-group-item list-group-item-action">
                <i class="fa fa-wallet me-2"></i> Expenses
              </a>
              <a href="/dashboard/about_me" class="list-group-item list-group-item-action">
                <i class="fa fa-user me-2"></i> About Me
              </a>
            </div>
          </div>

          <!-- Main Content -->
          <div class="dashboard-content col">

            <h2 class="fw-bold mb-3 text-primary">Leave Management</h2>
            <h6 class="text-muted mb-4">
              <i class="fa fa-user-circle me-1"></i>
              <t t-esc="data['employee']"/> | Joined: <t t-esc="data['joining_date']"/>
            </h6>

            <!-- Leave Summary Cards -->
            <div class="row g-4 mb-4">
              <!-- Define colors once -->
              <t t-set="colors" t-value="[
                'linear-gradient(45deg, #0d6efd, #4dabf7)',
                'linear-gradient(45deg, #198754, #20c997)',
                'linear-gradient(45deg, #ffc107, #fd7e14)',
                'linear-gradient(45deg, #dc3545, #ff6b6b)',
                'linear-gradient(45deg, #6f42c1, #d63384)',
                'linear-gradient(45deg, #0dcaf0, #17a2b8)',
                'linear-gradient(45deg, #fd7e14, #ff922b)',
                'linear-gradient(45deg, #6610f2, #6f42c1)',
                'linear-gradient(45deg, #198754, #6f42c1)',
                'linear-gradient(45deg, #e83e8c, #ff6f91)'
              ]"/>

              <!-- Pre-compute colors length -->
              <t t-set="color_count" t-value="len(colors)"/>

              <!-- Enumerate leave_summary with index -->
              <t t-foreach="list(enumerate(data['leave_summary'].items()))" t-as="row">
                <t t-set="i" t-value="row[0]"/>
                <t t-set="leave" t-value="row[1]"/>
                <t t-set="card_color" t-value="colors[i % color_count]"/>

                <div class="col-md-3">
                  <div class="summary-card" t-attf-style="background: {{ card_color }}">
                    <div class="summary-icon"><i class="fa fa-plane-departure"></i></div>
                    <h6><t t-esc="leave[0]"/></h6>
                    <h3><t t-esc="leave[1]"/> days</h3>
                  </div>
                </div>
              </t>

              <!-- Fallback when no data -->
              <t t-if="not data['leave_summary']">
                <div class="col-12 text-center text-muted">No leave data available</div>
              </t>
            </div>

            <!-- Leave Chart -->
            <div class="card shadow-sm rounded-4 mb-4">
              <div class="card-body">
                <h5 class="fw-bold mb-3">Leave Distribution</h5>
                <canvas id="leaveChart" height="120"></canvas>
              </div>
            </div>

            <script>
              document.addEventListener("DOMContentLoaded", function () {
                const ctx = document.getElementById('leaveChart').getContext('2d');
                new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: [
                      <t t-foreach="data['leave_summary'].keys()" t-as="type">
                        "<t t-esc='type'/>",
                      </t>
                    ],
                    datasets: [{
                      label: 'Leave Days',
                      data: [
                        <t t-foreach="data['leave_summary'].values()" t-as="days">
                          <t t-esc='days'/>,
                        </t>
                      ],
                      backgroundColor: [
                        '#0d6efd','#198754','#ffc107','#dc3545','#6f42c1',
                        '#0dcaf0','#fd7e14','#6610f2','#20c997','#e83e8c'
                      ]
                    }]
                  },
                  options: {
                    responsive: true,
                    scales: {
                      y: { beginAtZero: true }
                    }
                  }
                });
              });
            </script>

            <!-- Leave Table -->
            <div class="card shadow-sm rounded-4">
              <div class="card-body">
                <h5 class="fw-bold mb-3">Leave Details</h5>
                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead class="table-dark">
                      <tr>
                        <th>Type</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Days</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <t t-foreach="data['leaves']" t-as="leave">
                        <tr>
                          <td><span class="badge bg-primary badge-leave"><t t-esc="leave['type']"/></span></td>
                          <td><t t-esc="leave['from']"/></td>
                          <td><t t-esc="leave['to']"/></td>
                          <td><t t-esc="leave['days']"/></td>
                          <td>
                            <t t-if="leave.get('status')=='validate'">
                              <span class="badge bg-success">Approved</span>
                            </t>
                            <t t-if="leave.get('status')=='confirm'">
                              <span class="badge bg-info">To Approve</span>
                            </t>
                            <t t-if="leave.get('status')=='refuse'">
                              <span class="badge bg-danger">Refused</span>
                            </t>
                          </td>
                        </tr>
                      </t>
                      <t t-if="not data['leaves']">
                        <tr>
                          <td colspan="5" class="text-center text-muted">No leaves this month</td>
                        </tr>
                      </t>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div> <!-- End content -->
        </div>
      </div>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const menuItems = document.querySelectorAll("#sidebarMenu a");
          const currentPath = window.location.pathname;

          menuItems.forEach(item => {
            item.classList.remove("active");
            if (item.getAttribute("href") === currentPath) {
              item.classList.add("active");
            }
          });
        });
      </script>


    </t>
  </template>
</odoo>
